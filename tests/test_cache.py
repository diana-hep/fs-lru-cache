#!/usr/bin/env python

# Copyright 2017 DIANA-HEP
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import os
import shutil
import tempfile
import unittest

from hepquery.cache import *

def lstree(base, path=""):
    for item in sorted(os.listdir(os.path.join(base, path))):
        if os.path.isdir(os.path.join(base, path, item)):
            yield os.path.join(path, item) + os.sep
            for x in lstree(base, os.path.join(path, item)):
                yield x
        else:
            yield os.path.join(path, item)

class TestCache(unittest.TestCase):
    def runTest(self):
        pass
    
    def test_directory_structure(self):
        filling = [
            ["0.a"],
            ["0.a", "1.b"],
            ["0.a", "1.b", "2.c"],
            ["0/", "0/0.a", "0/1.b", "0/2.c", "1/", "1/0.d"],
            ["0/", "0/0.a", "0/1.b", "0/2.c", "1/", "1/0.d", "1/1.e"],
            ["0/", "0/0.a", "0/1.b", "0/2.c", "1/", "1/0.d", "1/1.e", "1/2.f"],
            ["0/", "0/0.a", "0/1.b", "0/2.c", "1/", "1/0.d", "1/1.e", "1/2.f", "2/", "2/0.g"],
            ["0/", "0/0.a", "0/1.b", "0/2.c", "1/", "1/0.d", "1/1.e", "1/2.f", "2/", "2/0.g", "2/1.h"],
            ["0/", "0/0.a", "0/1.b", "0/2.c", "1/", "1/0.d", "1/1.e", "1/2.f", "2/", "2/0.g", "2/1.h", "2/2.i"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s", "2/0/1.t"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s", "2/0/1.t", "2/0/2.u"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s", "2/0/1.t", "2/0/2.u", "2/1/", "2/1/0.v"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s", "2/0/1.t", "2/0/2.u", "2/1/", "2/1/0.v", "2/1/1.w"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s", "2/0/1.t", "2/0/2.u", "2/1/", "2/1/0.v", "2/1/1.w", "2/1/2.x"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s", "2/0/1.t", "2/0/2.u", "2/1/", "2/1/0.v", "2/1/1.w", "2/1/2.x", "2/2/", "2/2/0.y"],
            ["0/", "0/0/", "0/0/0.a", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s", "2/0/1.t", "2/0/2.u", "2/1/", "2/1/0.v", "2/1/1.w", "2/1/2.x", "2/2/", "2/2/0.y", "2/2/1.z"],
        ]

        touching = [
            ["0/", "0/0/", "0/0/1.b", "0/0/2.c", "0/1/", "0/1/0.d", "0/1/1.e", "0/1/2.f", "0/2/", "0/2/0.g", "0/2/1.h", "0/2/2.i", "1/", "1/0/", "1/0/0.j", "1/0/1.k", "1/0/2.l", "1/1/", "1/1/0.m", "1/1/1.n", "1/1/2.o", "1/2/", "1/2/0.p", "1/2/1.q", "1/2/2.r", "2/", "2/0/", "2/0/0.s", "2/0/1.t", "2/0/2.u", "2/1/", "2/1/0.v", "2/1/1.w", "2/1/2.x", "2/2/", "2/2/0.y", "2/2/1.z", "2/2/2.a"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/1.e", "0/0/1/2.f", "0/0/2/", "0/0/2/0.g", "0/0/2/1.h", "0/0/2/2.i", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/1.k", "0/1/0/2.l", "0/1/1/", "0/1/1/0.m", "0/1/1/1.n", "0/1/1/2.o", "0/1/2/", "0/1/2/0.p", "0/1/2/1.q", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/0.s", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/0.g", "0/0/2/1.h", "0/0/2/2.i", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/1.k", "0/1/0/2.l", "0/1/1/", "0/1/1/0.m", "0/1/1/1.n", "0/1/1/2.o", "0/1/2/", "0/1/2/0.p", "0/1/2/1.q", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/0.s", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/0/2/2.i", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/1.k", "0/1/0/2.l", "0/1/1/", "0/1/1/0.m", "0/1/1/1.n", "0/1/1/2.o", "0/1/2/", "0/1/2/0.p", "0/1/2/1.q", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/0.s", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/1.k", "0/1/0/2.l", "0/1/1/", "0/1/1/0.m", "0/1/1/1.n", "0/1/1/2.o", "0/1/2/", "0/1/2/0.p", "0/1/2/1.q", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/0.s", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/0.m", "0/1/1/1.n", "0/1/1/2.o", "0/1/2/", "0/1/2/0.p", "0/1/2/1.q", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/0.s", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/1/2.o", "0/1/2/", "0/1/2/0.p", "0/1/2/1.q", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/0.s", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/1.q", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/0.s", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/0.s", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/0/2.u", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/1.w", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/0.y", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w"],
            ["0/", "0/0/", "0/0/0/", "0/0/0/1.b", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y"],
            ["0/", "0/0/", "0/0/1/", "0/0/1/0.d", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b"],
            ["0/", "0/0/", "0/0/1/", "0/0/1/2.f", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d"],
            ["0/", "0/0/", "0/0/2/", "0/0/2/1.h", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f"],
            ["0/", "0/1/", "0/1/0/", "0/1/0/0.j", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h"],
            ["0/", "0/1/", "0/1/0/", "0/1/0/2.l", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j"],
            ["0/", "0/1/", "0/1/1/", "0/1/1/1.n", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j", "1/1/2/2.l"],
            ["0/", "0/1/", "0/1/2/", "0/1/2/0.p", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j", "1/1/2/2.l", "1/2/", "1/2/0/", "1/2/0/0.n"],
            ["0/", "0/1/", "0/1/2/", "0/1/2/2.r", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j", "1/1/2/2.l", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p"],
            ["0/", "0/2/", "0/2/0/", "0/2/0/1.t", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j", "1/1/2/2.l", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p", "1/2/0/2.r"],
            ["0/", "0/2/", "0/2/1/", "0/2/1/0.v", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j", "1/1/2/2.l", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p", "1/2/0/2.r", "1/2/1/", "1/2/1/0.t"],
            ["0/", "0/2/", "0/2/1/", "0/2/1/2.x", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j", "1/1/2/2.l", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p", "1/2/0/2.r", "1/2/1/", "1/2/1/0.t", "1/2/1/1.v"],
            ["0/", "0/2/", "0/2/2/", "0/2/2/1.z", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j", "1/1/2/2.l", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p", "1/2/0/2.r", "1/2/1/", "1/2/1/0.t", "1/2/1/1.v", "1/2/1/2.x"],
            ["0/", "0/2/", "0/2/2/", "0/2/2/2.a", "1/", "1/0/", "1/0/0/", "1/0/0/0.c", "1/0/0/1.e", "1/0/0/2.g", "1/0/1/", "1/0/1/0.i", "1/0/1/1.k", "1/0/1/2.m", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/1/1/", "1/1/1/0.b", "1/1/1/1.d", "1/1/1/2.f", "1/1/2/", "1/1/2/0.h", "1/1/2/1.j", "1/1/2/2.l", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p", "1/2/0/2.r", "1/2/1/", "1/2/1/0.t", "1/2/1/1.v", "1/2/1/2.x", "1/2/2/", "1/2/2/0.z"],
        ]

        working = tempfile.mkdtemp()
        directory = tempfile.mkdtemp()

        try:
            c = Cache(directory, 1024, maxperdir=3)

            for i in range(26):
                filename = os.path.join(working, "file{:02d}".format(i))
                open(filename, "w").write("hi")

                c.newfile(chr(i + ord("a")), filename)

                self.assertEqual(filling[i], list(lstree(directory)))

            c2 = Cache.adopt(directory, 1024, maxperdir=3)
            self.assertEqual(c.lookup, c2.lookup)
            self.assertEqual(c.numbytes, c2.numbytes)
            self.assertEqual(c.depth, c2.depth)
            self.assertEqual(c.number, c2.number)

            for i, n in enumerate(chr(j + ord("a")) for j in list(range(0, 26, 2)) + list(range(1, 26, 2))):
                c.touch(n)
                self.assertEqual(touching[i], list(lstree(directory)))

            c3 = Cache.adopt(directory, 1024, maxperdir=3)
            self.assertEqual(c.lookup, c3.lookup)
            self.assertEqual(c.numbytes, c3.numbytes)
            self.assertEqual(c.depth, c3.depth)
            self.assertEqual(c.number, c3.number)

            copy = os.path.join(working, "copy")
            shutil.copytree(directory, copy)

            c4 = Cache.adopt(copy, 1024, maxperdir=3)
            self.assertEqual(c.lookup, c4.lookup)
            self.assertEqual(c.numbytes, c4.numbytes)
            self.assertEqual(c.depth, c4.depth)
            self.assertEqual(c.number, c4.number)
            
            # do them in bulk (to avoid unnecessary directory listings)
            c.touch(*[chr(j + ord("a")) for j in range(0, 13)])

            # or do them one at a time
            for n in [chr(j + ord("a")) for j in range(0, 13)]:
                c4.touch(n)

            # should yield the same directory structure
            self.assertEqual(list(lstree(directory)), list(lstree(copy)))

            self.assertEqual(c.lookup, c4.lookup)
            self.assertEqual(c.numbytes, c4.numbytes)
            self.assertEqual(c.depth, c4.depth)
            self.assertEqual(c.number, c4.number)

            self.assertEqual(c.numbytes, 52)

            filename = os.path.join(working, "big")
            open(filename, "w").write("x" * (c.limitbytes - c.numbytes))
            c.newfile("big", filename)

            self.assertEqual(c.numbytes, 1024)
            self.assertEqual(list(lstree(directory)), ["1/", "1/0/", "1/0/2/", "1/0/2/0.o", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p", "1/2/0/2.r", "1/2/1/", "1/2/1/0.t", "1/2/1/1.v", "1/2/1/2.x", "1/2/2/", "1/2/2/0.z", "1/2/2/1.a", "1/2/2/2.b", "2/", "2/0/", "2/0/0/", "2/0/0/0.c", "2/0/0/1.d", "2/0/0/2.e", "2/0/1/", "2/0/1/0.f", "2/0/1/1.g", "2/0/1/2.h", "2/0/2/", "2/0/2/0.i", "2/0/2/1.j", "2/0/2/2.k", "2/1/", "2/1/0/", "2/1/0/0.l", "2/1/0/1.m", "2/1/0/2.big"])

            filename = os.path.join(working, "small1")
            open(filename, "w").write("x")
            c.newfile("small1", filename)

            self.assertEqual(c.numbytes, 1023)
            self.assertEqual(list(lstree(directory)), ["1/", "1/0/", "1/0/2/", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p", "1/2/0/2.r", "1/2/1/", "1/2/1/0.t", "1/2/1/1.v", "1/2/1/2.x", "1/2/2/", "1/2/2/0.z", "1/2/2/1.a", "1/2/2/2.b", "2/", "2/0/", "2/0/0/", "2/0/0/0.c", "2/0/0/1.d", "2/0/0/2.e", "2/0/1/", "2/0/1/0.f", "2/0/1/1.g", "2/0/1/2.h", "2/0/2/", "2/0/2/0.i", "2/0/2/1.j", "2/0/2/2.k", "2/1/", "2/1/0/", "2/1/0/0.l", "2/1/0/1.m", "2/1/0/2.big", "2/1/1/", "2/1/1/0.small1"])

            filename = os.path.join(working, "small2")
            open(filename, "w").write("x")
            c.newfile("small2", filename)

            self.assertEqual(c.numbytes, 1024)
            self.assertEqual(list(lstree(directory)), ["1/", "1/0/", "1/0/2/", "1/0/2/1.q", "1/0/2/2.s", "1/1/", "1/1/0/", "1/1/0/0.u", "1/1/0/1.w", "1/1/0/2.y", "1/2/", "1/2/0/", "1/2/0/0.n", "1/2/0/1.p", "1/2/0/2.r", "1/2/1/", "1/2/1/0.t", "1/2/1/1.v", "1/2/1/2.x", "1/2/2/", "1/2/2/0.z", "1/2/2/1.a", "1/2/2/2.b", "2/", "2/0/", "2/0/0/", "2/0/0/0.c", "2/0/0/1.d", "2/0/0/2.e", "2/0/1/", "2/0/1/0.f", "2/0/1/1.g", "2/0/1/2.h", "2/0/2/", "2/0/2/0.i", "2/0/2/1.j", "2/0/2/2.k", "2/1/", "2/1/0/", "2/1/0/0.l", "2/1/0/1.m", "2/1/0/2.big", "2/1/1/", "2/1/1/0.small1", "2/1/1/1.small2"])

            filename = os.path.join(working, "small3")
            open(filename, "w").write("hey, how's it goin?")
            c.newfile("small3", filename)

            self.assertEqual(c.numbytes, 1023)
            self.assertEqual(list(lstree(directory)), ["1/", "1/2/", "1/2/1/", "1/2/1/2.x", "1/2/2/", "1/2/2/0.z", "1/2/2/1.a", "1/2/2/2.b", "2/", "2/0/", "2/0/0/", "2/0/0/0.c", "2/0/0/1.d", "2/0/0/2.e", "2/0/1/", "2/0/1/0.f", "2/0/1/1.g", "2/0/1/2.h", "2/0/2/", "2/0/2/0.i", "2/0/2/1.j", "2/0/2/2.k", "2/1/", "2/1/0/", "2/1/0/0.l", "2/1/0/1.m", "2/1/0/2.big", "2/1/1/", "2/1/1/0.small1", "2/1/1/1.small2", "2/1/1/2.small3"])

        finally:
            shutil.rmtree(working)
            shutil.rmtree(directory)
